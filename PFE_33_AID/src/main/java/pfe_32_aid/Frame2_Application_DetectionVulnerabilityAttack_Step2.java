/**
 * @author MÃ©lissa MAZROU
 * @author Redouane OTMANI
 * 
 */
package pfe_32_aid;

import java.awt.Color;
import java.awt.EventQueue;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigInteger;
import java.net.URL;
import java.util.HashMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.swing.DefaultComboBoxModel;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JSeparator;
import javax.swing.JTextField;
import javax.swing.UIManager;
import javax.swing.plaf.FontUIResource;

import org.apache.commons.io.FileUtils;

import javax.swing.SwingConstants;
import javax.swing.ToolTipManager;

public class Frame2_Application_DetectionVulnerabilityAttack_Step2 {

	public static JFrame frmDetectVulnerabilityAttackStep2=null;
	
	public static HashMap<String, BigInteger> Step2_hm_AdressesSmartContrats = new HashMap<String, BigInteger>();
	public static BigInteger Step2_LastMinedBlockNumber = BigInteger.valueOf(0);

	//
	public static JButton btnReturnStep1=null;	
	
	public static JLabel Step2_TitleLabel=null;
	public static JLabel Step2_SubTitleLabel=null;
	
	public static JLabel Step2_Label_SmartContractToAnalyze=null;
	public static JLabel Step2_Label_BlockStartAnalysis=null;
	public static JLabel Step2_Label_BlockEndAnalysis=null;
	
	public static JTextField Step2_textField_BlockStartAnalysis=null;
	public static JTextField Step2_textField_BlockEndAnalysis=null;

	
	public static JComboBox Step2_comboBox=null; 
	public static JButton Step2_btnConfirm=null;
	
	public static BigInteger Step2_BlockNumberStartAnalysis = null;
	public static BigInteger Step2_BlockNumberEndAnalysis = null;
	
	
	public static String YesNoArray[] = {"Yes", "No"};
	
	/**
	 * Create the application.
	 */

	
	
	public Frame2_Application_DetectionVulnerabilityAttack_Step2( 
			HashMap <String, BigInteger> hm_AdressesSmartContrats, 
			BigInteger numberOfLastMinedBlock
			) {
		initialiserToutesLesVariables();

		
		Step2_hm_AdressesSmartContrats = hm_AdressesSmartContrats;
		Step2_LastMinedBlockNumber = numberOfLastMinedBlock;
		
		initialize();
		initStep2();
	}

	
	/**
	 * Initialize the contents of the frame.
	 */

	public static void initialiserToutesLesVariables() {

		Step2_hm_AdressesSmartContrats = new HashMap<String, BigInteger>();
		Step2_LastMinedBlockNumber = BigInteger.valueOf(0);

		//
		btnReturnStep1=null;	
		
		Step2_TitleLabel=null;
		Step2_SubTitleLabel=null;
		
		Step2_Label_SmartContractToAnalyze=null;
		Step2_Label_BlockStartAnalysis=null;
		Step2_Label_BlockEndAnalysis=null;
		
		Step2_textField_BlockStartAnalysis=null;
		Step2_textField_BlockEndAnalysis=null;

		
		Step2_comboBox=null; 
		Step2_btnConfirm=null;
		
		Step2_BlockNumberStartAnalysis = null;
		Step2_BlockNumberEndAnalysis = null;
		
		
		
	}

	
	private void initialize() {
		frmDetectVulnerabilityAttackStep2 = new JFrame();
		frmDetectVulnerabilityAttackStep2.getContentPane().setBackground(new Color(0, 51, 102));
		frmDetectVulnerabilityAttackStep2.setTitle("Inserting additional information");
		frmDetectVulnerabilityAttackStep2.setBounds(0, 0, 1020, 600);
		frmDetectVulnerabilityAttackStep2.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frmDetectVulnerabilityAttackStep2.setResizable(false);
		frmDetectVulnerabilityAttackStep2.setLocationRelativeTo(null);
		frmDetectVulnerabilityAttackStep2.getContentPane().setLayout(null);


UIManager.put("OptionPane.messageFont", new FontUIResource(new Font("merriweather", Font.BOLD, 12)));					

		
		JSeparator separator_1 = new JSeparator();
		separator_1.setForeground(Color.BLACK);
		separator_1.setBounds(10, 652, 480, 2);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(separator_1);
		
		Step2_SubTitleLabel = new JLabel("Insert a range of blocks to analyse\r\n");
		Step2_SubTitleLabel.setHorizontalAlignment(SwingConstants.CENTER);
		Step2_SubTitleLabel.setForeground(new Color(46, 139, 87));
		Step2_SubTitleLabel.setBackground(new Color(240,240,240));
		Step2_SubTitleLabel.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 35));
		Step2_SubTitleLabel.setBounds(0, 220, 1016, 50);
		
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_SubTitleLabel);
		
		
		
		Step2_Label_SmartContractToAnalyze = new JLabel("Select a smart contract address \r\n");
		Step2_Label_SmartContractToAnalyze.setBackground(new Color(240, 240, 240));
		Step2_Label_SmartContractToAnalyze.setForeground(new Color(46, 139, 87));
		Step2_Label_SmartContractToAnalyze.setHorizontalAlignment(SwingConstants.CENTER);
		Step2_Label_SmartContractToAnalyze.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 35));
		Step2_Label_SmartContractToAnalyze.setBounds(0, 45, 1016, 50);
		
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_Label_SmartContractToAnalyze);

		//**************************
		int defaultDismissTimeout = ToolTipManager.sharedInstance().getDismissDelay();
		
		Step2_comboBox = new JComboBox();
		Step2_comboBox.setBackground(new Color(245, 245, 245));
		Step2_comboBox.setToolTipText(
				"<html>\r\n" + 
				"<body style=\"font-family:merriweather;\">"+
				"These are the smart contract address(es) available in the block range"
				+"</body>\r\n" + 
				"</html>");
		Step2_comboBox.setFont(new Font("Merriweather Light", Font.PLAIN, 20));
		Step2_comboBox.setBounds(293, 157, 432, 35);
		Step2_comboBox.addActionListener(new ActionListener() {
			
			public void actionPerformed(ActionEvent e) {
				Step2_textField_BlockStartAnalysis.setToolTipText(
						"<html>\r\n" + 
						"<body style=\"font-family:merriweather;\">\r\n" + 
						"The selected contract has been created in the block "+
			Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem())
						+"</body>\r\n" + 
						"</html>");
				
			}
		});
		
		Step2_comboBox.addMouseListener(new MouseAdapter() {
			  public void mouseEntered(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(8000);}
			  public void mouseExited(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(defaultDismissTimeout);}
			});
		

		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_comboBox);
		

		
		Step2_textField_BlockStartAnalysis = new JTextField();
		Step2_textField_BlockStartAnalysis.setFont(new Font("Merriweather Light", Font.PLAIN, 20));
		Step2_textField_BlockStartAnalysis.setBounds(473, 330, 252, 35);
		Step2_textField_BlockStartAnalysis.setBackground(new Color(245, 245, 245));
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_textField_BlockStartAnalysis);
		Step2_textField_BlockStartAnalysis.setColumns(10);
		Step2_textField_BlockStartAnalysis.addMouseListener(new MouseAdapter() {
			  public void mouseEntered(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(8000);}
			  public void mouseExited(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(defaultDismissTimeout);}
			});
		
		Step2_textField_BlockEndAnalysis = new JTextField();
		Step2_textField_BlockEndAnalysis.setFont(new Font("Merriweather Light", Font.PLAIN, 20));
		Step2_textField_BlockEndAnalysis.setBackground(new Color(245, 245, 245));
		Step2_textField_BlockEndAnalysis.setBounds(473, 386, 252, 35);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_textField_BlockEndAnalysis);
		Step2_textField_BlockEndAnalysis.setColumns(10);
		Step2_textField_BlockEndAnalysis.addMouseListener(new MouseAdapter() {
			  public void mouseEntered(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(8000);}
			  public void mouseExited(MouseEvent me) {ToolTipManager.sharedInstance().setDismissDelay(defaultDismissTimeout);}
			});
		
		Step2_Label_BlockStartAnalysis = new JLabel("Block Start Analysis");
		Step2_Label_BlockStartAnalysis.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 20));
		Step2_Label_BlockStartAnalysis.setForeground(new Color(192, 192, 192));
		Step2_Label_BlockStartAnalysis.setBounds(293, 330, 182, 34);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_Label_BlockStartAnalysis);
		
		Step2_Label_BlockEndAnalysis = new JLabel("Block End Analysis");
		Step2_Label_BlockEndAnalysis.setToolTipText("");
		Step2_Label_BlockEndAnalysis.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 20));
		Step2_Label_BlockEndAnalysis.setForeground(new Color(192, 192, 192));
		Step2_Label_BlockEndAnalysis.setBounds(293, 386, 170, 35);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_Label_BlockEndAnalysis);
		
		Step2_btnConfirm = new JButton("Continue");
		Step2_btnConfirm.setForeground(new Color(0, 0, 0));
		Step2_btnConfirm.setBackground(new Color(245, 245, 245));
		Step2_btnConfirm.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 20));
		Step2_btnConfirm.setBounds(777, 465, 180, 35);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(Step2_btnConfirm);
		

		Step2_btnConfirm.addActionListener(new ActionListener() {
			
			public void actionPerformed(ActionEvent e) {
				Step2_btnConfirm.setEnabled(false);
				try {

					Step2_BlockNumberStartAnalysis = BigInteger.valueOf(Integer.parseInt(Step2_textField_BlockStartAnalysis.getText()));
					Step2_BlockNumberEndAnalysis   = BigInteger.valueOf(Integer.parseInt(Step2_textField_BlockEndAnalysis.getText()));

					
					if(Step2_BlockNumberStartAnalysis.compareTo(BigInteger.valueOf(0))<0) {throw new Exception();}
					if(Step2_BlockNumberEndAnalysis.compareTo(BigInteger.valueOf(0))<0) {throw new Exception();}
					if((Step2_BlockNumberStartAnalysis.compareTo(Step2_BlockNumberEndAnalysis)>0)) {throw new Exception();}

					
					if((Step2_BlockNumberStartAnalysis.compareTo(Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem()))<0) 
							|| 
					   (Step2_BlockNumberEndAnalysis.compareTo(Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem()))<0))
					{
						JOptionPane.showMessageDialog(null, 
								"The contract you have selected has been created in the block "
								+Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem())+"."
								+ "\nPlease insert a start block number greater than or equal to this value",
								
								"Attention",JOptionPane.WARNING_MESSAGE);
					
						Step2_btnConfirm.setEnabled(true);
					}
					
					else {
						
						if((Step2_BlockNumberStartAnalysis.compareTo(Step2_LastMinedBlockNumber)>0) 
								|| 
								   (Step2_BlockNumberEndAnalysis.compareTo(Step2_LastMinedBlockNumber)>0)) {

							JOptionPane.showMessageDialog(null, 
									  "The block number you entered is invalid.\n"
									+ "The last block mined a few moments ago is the\n "
									+ Step2_LastMinedBlockNumber
									
									,"Attention",JOptionPane.WARNING_MESSAGE);
							
							Step2_btnConfirm.setEnabled(true);
						}else {
							
							JOptionPane.showMessageDialog(null, "You can continue"
									,"Next",JOptionPane.INFORMATION_MESSAGE);

							
							frmDetectVulnerabilityAttackStep2.dispose();
							initStep3_Part1();
							
						}
						
						
					}//end else
					
				} catch (Exception e2) {
					JOptionPane.showMessageDialog(null, 
							"Please select an analysis block range", 
							"Erreur", 
							JOptionPane.ERROR_MESSAGE);
					
					Step2_btnConfirm.setEnabled(true);
				}
				
			}
		});
		

		
		
		

		
		btnReturnStep1 = new JButton("Go back to previous step");
		btnReturnStep1.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				
				if(JOptionPane.showOptionDialog(null, 
						"Are you sure you want to go back to the previous step?", 
						"Back to previous step",
						0, JOptionPane.QUESTION_MESSAGE, null, YesNoArray, null) == JOptionPane.OK_OPTION) {

					frmDetectVulnerabilityAttackStep2.dispose();
					
					
	_Main frame2_Application_DetectionVulnerabilityAttack_Step1 =
			new _Main();
	 
	frame2_Application_DetectionVulnerabilityAttack_Step1.frmDetectVulnerabilyAttackStep1.setVisible(true);
					 
				}
			}
		});
		btnReturnStep1.setForeground(new Color(0, 0, 0));
		btnReturnStep1.setBackground(new Color(245, 245, 245));

		btnReturnStep1.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 20));
		btnReturnStep1.setBounds(582, 465, 180, 35);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(btnReturnStep1);

		
		JButton btnQuitter = new JButton("Quit\r\n");
		btnQuitter.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				
				if(JOptionPane.showOptionDialog(null, "Are you sure you want to leave SCVADetection?", 
						"Disconnect",
						0, JOptionPane.QUESTION_MESSAGE, null, YesNoArray, null) == JOptionPane.OK_OPTION) {
					//frmDetecterUneVulnerabilitattaqueEtape2.dispose();
					System.exit(0);
				}
			}
		});
		btnQuitter.setForeground(new Color(0, 0, 0));
		btnQuitter.setBackground(new Color(245, 245, 245));

		btnQuitter.setFont(new Font("Brandon Grotesque Regular", Font.PLAIN, 20));
		btnQuitter.setBounds(58, 465, 180, 35);		
		frmDetectVulnerabilityAttackStep2.getContentPane().add(btnQuitter);
		
		JLabel lblNewLabel = new JLabel("<html>\r\n<body>\r\nPlease select a smart contract address\r\n</body>\r\n</html>\r\n");
		lblNewLabel.setHorizontalAlignment(SwingConstants.CENTER);
		lblNewLabel.setForeground(Color.LIGHT_GRAY);
		lblNewLabel.setFont(new Font("Merriweather Light", Font.PLAIN, 20));
		lblNewLabel.setBounds(0, 96, 1016, 50);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(lblNewLabel);
		
		JLabel lblNewLabel_1 = new JLabel("<html>\r\n<body>\r\nPlease insert a start of analysis block number and an end of analysis block number\r\n</body>\r\n</html>\r\n");
		lblNewLabel_1.setForeground(Color.LIGHT_GRAY);
		lblNewLabel_1.setFont(new Font("Merriweather Light", Font.PLAIN, 20));
		lblNewLabel_1.setHorizontalAlignment(SwingConstants.CENTER);
		lblNewLabel_1.setBounds(0, 264, 1016, 50);
		frmDetectVulnerabilityAttackStep2.getContentPane().add(lblNewLabel_1);
		
		
		
	}//end void initialize()

	
	public static void initStep2() {
		btnReturnStep1.setEnabled(true);
		Step2_comboBox.setModel(new DefaultComboBoxModel(Step2_hm_AdressesSmartContrats.keySet().toArray()));


		
		  Step2_textField_BlockStartAnalysis.setToolTipText(
				  "<html>\r\n" + 
				  "<body style=\"font-family:merriweather;\">"+
				  "The selected contract has been created in the block "+
					Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem())
				  +"</body>\r\n" + 
				  "</html>"
				  );
					
					Step2_textField_BlockEndAnalysis.setToolTipText(
							"<html>\r\n" + 
							"<body style=\"font-family:merriweather;\">\r\n" + 
							"The Last Mined Block "+Step2_LastMinedBlockNumber
							+"</body>\r\n" + 
							"</html>"
							);
					
		 
		 
	}

	
	public static BigInteger getBlockNumberOfContractCreationStep2(String contractAddress) {
		

		try {
			
			BufferedReader brGetTransactionHash = null;
		    String contentGetTransactionHash=null;
		    
	        URL urlGetTransactionHash= new URL("https://etherscan.io/address/"+
						contractAddress);
		
	           brGetTransactionHash = new BufferedReader(new InputStreamReader(urlGetTransactionHash.openStream()));
	           
	           String lineGetTransactionHash;
	           StringBuilder sbGetTransactionHash = new StringBuilder();
	           
	           while ((lineGetTransactionHash = brGetTransactionHash.readLine()) != null) {sbGetTransactionHash.append(lineGetTransactionHash);sbGetTransactionHash.append(System.lineSeparator());}
	           
	           contentGetTransactionHash = sbGetTransactionHash.toString();

	           brGetTransactionHash.close();
	          

	           //We retrieve the hash of the transaction that created our contract with a regular expression
	   		Pattern patternGetTransactionHash = Pattern.compile("at txn <a href='/tx/"
					+ "(.*)' data-toggle='tooltip' title='Creator Txn Hash' class='hash-tag text-truncate'>(.*)</a>");
			
			
			Matcher matcherGetTransactionHash = patternGetTransactionHash.matcher(contentGetTransactionHash);
			
			
			String HashTransaction=null;
			
			while(matcherGetTransactionHash.find()) {
				HashTransaction= matcherGetTransactionHash.group(1);
			}	           


			/************************************************************************************/			
			  
			BufferedReader brGetBlockNumber = null;
		    String contentGetBlockNumber=null;

	        
	        URL urlGetBlockNumber= new URL("https://api.etherscan.io/api?module=proxy"
	        		+ "&action=eth_getTransactionByHash"
	        		+ "&txhash="+HashTransaction
	        		+ "&apikey=PUT_HERE_YOUR_API_KEY");
			
	        

	        
	           brGetBlockNumber = new BufferedReader(new InputStreamReader(urlGetBlockNumber.openStream()));
	           
	           
	           
	           String lineGetBlockNumber;
	           StringBuilder sbGetBlockNumber = new StringBuilder();
	           
	           
	           while ((lineGetBlockNumber = brGetBlockNumber.readLine()) != null) {
	        	   sbGetBlockNumber.append(lineGetBlockNumber);
	        	   sbGetBlockNumber.append(System.lineSeparator());}
	           
	           
	           
	           
	           contentGetBlockNumber = sbGetBlockNumber.toString();
	           brGetBlockNumber.close();
			

		   		Pattern patternGetBlockNumber = Pattern.compile("\"blockNumber\":\"0x(.*)\",\"from\"");
				
				
				Matcher matcherGetBlockNumber = patternGetBlockNumber.matcher(contentGetBlockNumber);
				
				
				String NumBlocHexa=null;
				
				while(matcherGetBlockNumber.find()) {
					NumBlocHexa= matcherGetBlockNumber.group(1);
				}	           
	           
				BigInteger NumBlocDecimal = new BigInteger(NumBlocHexa, 16);

	           
				return NumBlocDecimal;	           
		
		} catch (Exception e) {
			JOptionPane.showMessageDialog(null,e.getMessage(),"Attention",JOptionPane.WARNING_MESSAGE);
		}
		
		return null;
		
	}

	
	public static BigInteger getLastMinedBlock_Step2() {
		try {
			
			BufferedReader brGetBlockNumber = null;
		    String contentGetBlockNumber=null;

	        
	        URL urlGetBlockNumber= new URL("https://api.etherscan.io/api?module=proxy"
	        		+ "&action=eth_blockNumber"
	        		+ "&apikey=PUT_HERE_YOUR_API_KEY");
			
	        
	           brGetBlockNumber = new BufferedReader(new InputStreamReader(urlGetBlockNumber.openStream()));
	           
	           
	           
	           String lineGetBlockNumber;
	           StringBuilder sbGetBlockNumber = new StringBuilder();
	           
	           
	           while ((lineGetBlockNumber = brGetBlockNumber.readLine()) != null) {
	        	   sbGetBlockNumber.append(lineGetBlockNumber);
	        	   sbGetBlockNumber.append(System.lineSeparator());}
	           
	           contentGetBlockNumber = sbGetBlockNumber.toString();
	           brGetBlockNumber.close();
			

		   		Pattern patternGetBlockNumber = Pattern.compile("\"result\":\"0x(.*)\"}");
				
				
				Matcher matcherGetBlockNumber = patternGetBlockNumber.matcher(contentGetBlockNumber);
				
				
				String blockNumberHexa=null;
				
				while(matcherGetBlockNumber.find()) {
					blockNumberHexa= matcherGetBlockNumber.group(1);
				}	           
	           
				BigInteger blockNumberDecimal = new BigInteger(blockNumberHexa, 16);

	           
				return blockNumberDecimal;	           
		
		} catch (Exception e) {
			JOptionPane.showMessageDialog(null,e.getMessage(),"Attention",JOptionPane.WARNING_MESSAGE);
		}
		
		return null;
		
	}
		


/********************************************************************************************************************************/	
/********************************************************************************************************************************/	
/********************************************************************************************************************************/
/********************************************************************************************************************************/	
/***********************************************Step 03*************************************************************************/

	public static void initStep3_Part1() {
		Frame3_DetectionAidModules frame3_DetectionAidModules = new Frame3_DetectionAidModules(
				Step2_comboBox.getSelectedItem().toString().toLowerCase(),
				Step2_hm_AdressesSmartContrats.get(Step2_comboBox.getSelectedItem()),
				Step2_BlockNumberStartAnalysis, 
				Step2_BlockNumberEndAnalysis,
				Step2_hm_AdressesSmartContrats,
				Step2_LastMinedBlockNumber
				);
		frame3_DetectionAidModules.setVisible(true);
		frame3_DetectionAidModules.initStep3_Part2();
		
	}


}
